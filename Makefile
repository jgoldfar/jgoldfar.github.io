SHELL:=/bin/bash
UNAME:=$(shell uname -s)
HUGO:=bin/hugo
HUGO_VERSION:=0.67.1

# https://gohugo.io/getting-started/installing
ifeq ($(UNAME),Darwin)
bin/hugo_extended_${HUGO_VERSION}_macOS-64bit.tar.gz:
	curl -L https://github.com/gohugoio/hugo/releases/download/v${HUGO_VERSION}/hugo_extended_${HUGO_VERSION}_macOS-64bit.tar.gz -o $@
$(HUGO): bin/hugo_extended_${HUGO_VERSION}_macOS-64bit.tar.gz
	cd bin && tar xvzf $(notdir $<)
endif

ifeq ($(UNAME),Linux)
bin/hugo_extended_${HUGO_VERSION}_Linux-64bit.tar.gz:
	curl -L https://github.com/gohugoio/hugo/releases/download/v${HUGO_VERSION}/hugo_extended_${HUGO_VERSION}_Linux-64bit.tar.gz -o $@
$(HUGO): bin/hugo_extended_${HUGO_VERSION}_Linux-64bit.tar.gz
	cd bin && tar xvzf $(notdir $<)
endif

### CV/Resume
CVDownloadPath:=https://dl.bintray.com/jgoldfar/ResumePublic/
CVPath:=static/cv


CVBibFiles:=cont-talks.bib inv-talks.bib posters.bib pubs.bib
CVFiles:=cv-default.pdf res-default.pdf $(CVBibFiles)

# Accumulator for cv-deps
CV_DEP_TARGETS:=

# Define template for downloading a single cv file using curl
define CVPULL_template
$$(CVPath)/$(1):
	mkdir -p $$(CVPath)
	curl -L "$$(CVDownloadPath)/$(1)" -o $$@
CV_DEP_TARGETS+=$$(CVPath)/$(1)
endef

# Evaluate the template above for each file in CVFiles
$(foreach file,$(CVFiles),$(eval $(call CVPULL_template,$(file))))

cv-deps: ${CV_DEP_TARGETS} ## Pull in CV files. There must be a better way!
.PHONY: cv-deps

# Download bibtex 2 bibjson converter from github repo
deps/bib2json.py:
	curl -L "https://raw.githubusercontent.com/jgoldfar/bibserver/jgoldfar-bibtexparser-23-support/parserscrapers_plugins/bibtex.py" -o $@
	chmod a+x $@
.PHONY: deps/bib2json.py

# Convert bibfile into bibJSON files
data/cv/%.json: $(CVPath)/%.bib deps/bib2json.py
	mkdir -p $(dir $@)
	cat $< | deps/bib2json.py > $@
	-cp $@ $(subst -,,$@)

cv-bibjson-datafiles: $(addprefix data/cv/,$(CVBibFiles:.bib=.json)) ## Generate JSON files from CV bibliography
.PHONY: cv-bibjson-datafiles

clean-cv-deps:
	$(RM) -r $(CVPath)
.phony: clean-cv-deps
CLEAN_TARGETS+=cv-deps

## Hugo Generation
HUGOFILE:=config.toml

serve: $(HUGOFILE) $(HUGO) ## Serve page for local development
	$(HUGO) --disableFastRender --verbose server
.PHONY: serve

new: $(HUGOFILE) $(HUGO) ## Make a new post (not super useful, just trying out Hugo)
ifeq ($(FileName),)
	@echo "Usage: make new FileName=..."
	@echo "i.e. make new FileName=blog/newBlogPost.md"
else # FileName set
ifeq ($(basename $(FileName)),$(FileName))
	$(HUGO) new $(FileName).md
else # Already has an extension
	$(HUGO) new $(FileName)
endif # Switch on existence of extension
endif # Switch on definition of FileName
.PHONY: new

### Generate site
generate: $(HUGO) $(HUGOFILE) ## Generate website
	$(HUGO) --verbose
.PHONY: generate

GitRepoName:=jgoldfar.github.io

# Note: CI environment variable is (or should be) only set on CI services.
# This is when config should be set.
init-git: ## Initialize git repository for Github Pages
	@echo "WIP"
	exit 1
	$(RM) -r $(GitRepoName)
ifdef CI
	git -C ./$(GitRepoName) config user.email "ci@bitbucket.org" || echo "email set failed."
	git -C ./$(GitRepoName) config user.name "Bitbucket CI" || echo "username set failed."
endif
.PHONY: init-git

generate-git: $(HUGOFILE) $(HUGO) ## Generate hugo site into git repository
	$(HUGO) --verbose --destination ${GitRepoName}
.PHONY: generate-git

push-git: ## Push generated changes to git repository
	[[ -d "${GitRepoName}" ]] || ( echo "No changes generated." ; exit 1 )
	git -C ./$(GitRepoName) add -A .
	git -C ./$(GitRepoName) commit -m "Update with changes generated by commit $(shell )" || echo "Nothing to commit."
	git -C ./$(GitRepoName) push || echo "No updates to content!"
.PHONY: push-git

clean-git:
	$(RM) -r ${GitRepoName}

deploy-git: init-git generate-git push-git clean-git ## Run full deployment to Github Pages
.PHONY: deploy-git



clean: ${CLEAN_TARGETS} ## Cleanup generated files
	$(RM) -r ${GitRepoName}
	$(RM) ${HUGO} bin/LICENSE bin/README.md
.PHONY: clean
