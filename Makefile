SHELL=/bin/bash
RSYNC=rsync -a
UNAME=$(shell uname -s)
HUGO?=bin/hugo

ifeq ($(UNAME),Darwin)
$(HUGO): bin/hugo_0.40.3_macOS-64bit.tar.gz
	cd bin && tar xvzf $(notdir $<)
endif

ifeq ($(UNAME),Linux)
$(HUGO): bin/hugo_0.40.3_Linux-64bit.tar.gz
	cd bin && tar xvzf $(notdir $<)
endif

### Dependencies
pull-deps: reading-group-deps cv-deps


ARGDownloadPath=https://bitbucket.org/jgoldfar/algebrareadinggroupnotes/downloads
ARGCoursePath=static/AlgebraReadingGroup
ARGFiles=hersteinExercises.pdf munkresExercises.pdf index.htm
InstallDirs+=$(ARGCoursePath)

reading-group-deps:
	mkdir -p $(ARGCoursePath)
	$(foreach file, $(ARGFiles), \
		curl -L "$(ARGDownloadPath)/$(file)" -o "$(ARGCoursePath)/$(file)"; \
	)

CVDownloadPath=https://bitbucket.org/jgoldfar/resumepublic/downloads
CVPath=static/cv
InstallDirs+=$(CVPath)
CVFiles=cv@default.pdf res@default.pdf
cv-deps-pull:
	mkdir -p $(CVPath)
	$(foreach file, $(CVFiles), \
		curl -L "$(CVDownloadPath)/$(file)" -o "$(CVPath)/$(file)"; \
	)

cv-deps: cv-deps-pull $(addprefix $(CVPath)/,cv.pdf res.pdf)

$(CVPath)/%.pdf: $(CVPath)/%@default.pdf
	mv $< $@

HUGOFILE := config.toml

serve: $(HUGOFILE) $(HUGO)
	$(HUGO) --verbose server

### Generate site
GitRepoName=jgoldfar.github.io
gen-git: $(HUGOFILE) $(HUGO)
	$(HUGO) --verbose
	echo "moving public/ to $(GitRepoName) subdirectory."
	$(RSYNC) ./public/* ./$(GitRepoName)/

#TODO: set identity only on CI
$(info $(CI))

init-git:
	if [[ ! -d $(GitRepoName) ]] ; then \
	git clone git@github.com:jgoldfar/$(GitRepoName).git ;\
	fi
	$(RM) -r $(GitRepoName)/*
	git -C ./$(GitRepoName) config user.email "ci@bitbucket.org" || echo "email set failed."
	git -C ./$(GitRepoName) config user.name "Bitbucket CI" || echo "username set failed."

push-git: init-git gen-git
	git -C ./$(GitRepoName) add -A .
	git -C ./$(GitRepoName) commit -m "Update with changes generated by hg commit $(shell hg log --limit 1 -T '{node}')"
	git -C ./$(GitRepoName) push

clean:
	$(RM) -r public
	$(RM) -r $(InstallDirs)
	$(RM) -r $(CloneDirs)
	$(RM) -r jgoldfar.github.io
	$(RM) bin/hugo bin/LICENSE bin/README.md
